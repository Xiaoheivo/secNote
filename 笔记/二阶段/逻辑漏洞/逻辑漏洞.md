# 逻辑漏洞

[toc]

## 验证码漏洞

一般验证码生成和验证的流程： 

客户端发起请求-> 服务端响应并创建一个新的 SessionID 同时生成随机验证码，将验证码和 SessionID 一并返回给客户端-> 客户端提交验证码连同 SessionID 给服务端-> 服务端验证验证码同时销毁当前会 话，返回给客户端结果。

 如果生成的验证码有问题，或者验证的方式有问题，这就存在验证码绕过漏洞。

## 验证码漏洞分类

1. 验证码在前端验证,并没有传到后端
   
   - 验证码空值绕过,抓包去掉验证码的参数后可以正常登录http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-0155066
   
2. 设置了验证码但是没有校验,随便输都可以登录

3. 验证码可以重复使用,用了一次之后虽然验证码图片变了,但原来的验证码还能用http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2016-0169672

4. 验证码可识别

   - 数字、字母验证码干扰低可轻易识别,可以使用PKAV工具自动识别绕过,使用教程https://www.likecs.com/show-204165580.html?sc=8900

   - 图片验证码类型太少、干扰低,容易识别http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-0102178

5. 验证码传到前端

   1. 可以在源码中找验证码http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-0146767
   2. URL中、隐藏表单中含验证码:http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2014-071289
   3. 验证码藏在cookie里面,可以分析一下cookie中有没有验证码的参数
      - 乌云案例,修改cookie之后绕过验证码https://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2016-0215312

6. 验证码有规则,比如时间戳的后六位用rand函数进行随机,在线查询时间戳:https://www.beijing-time.org/shijianchuo/，或者使用时间戳后六位或后4位进行md5(时间差在一分钟或两分钟可能有效)

   - 估计验证码生成的时间,将其转换成Unix时间戳,取前后60秒的数字范围作为验证码

7. 万能验证码,开发人员在开发阶段调试的时候可能留下一个调试用的固定验证码,可以直接绕过验证,如果项目上线时没有删除该功能,则可以利用爆破尝试一些常用的数字验证码验证码(甚至有可能是极短的验证码,爆破时可以尝试单个数字和单个所有字符,即便是前端加了位数验证,也可以直接尝试burp发包)

   万能验证码字典:1111-9999,0000,1234,1024,aaaa等;

   

## 密码找回相关的验证码

### 密码找回的方式

- 验证码找回

  - 手机验证码
  - 邮箱验证码

- 通过重置链接重新设置密码(点击链接后可以重新设置密码)

  ![image-20221011180430672](%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E.assets/image-20221011180430672.png)

  这种链接很有可能是修改密码的页面md5后的url,可以尝试加上用户名等去猜解

### 可能的利用姿势

1. 验证码发送后还给前端也返回了一个（http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-0114577）

2. 验证码可多次使用(爆破)（http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-0155994）

3. 验证码可控（http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2014-086716）

4. 直接修改密码（http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2013-040908）

5. 跳过验证码输入的步骤

   1. URL里可能有步骤,直接把步骤改为下一个
   2. 源码里有输入验证码后的跳转连接,直接跳到那个链接

6. 越权漏洞(用自己的验证码,改请求包越权修改他人密码)

   http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-0102205

   http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2013-016896



## 爆破带token验证的页面

可以使用burp抓取每次请求后响应包中的token作为下一次爆破使用

步骤

1. 拦截一个请求包并转发,获取最新的响应包

2. 将该包发送到爆破模块

   ![image-20221011182629990](%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E.assets/image-20221011182629990.png)

   需要注意的是,攻击模式只能用第三个,并且建议固定用户名,只爆破密码,用户名手动更换

3. 标记好payload位置,密码自己设置字典

   ![image-20221011182902461](%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E.assets/image-20221011182902461.png)

4. 抓取响应包内的指定内容

   ![image-20221011183034486](%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E.assets/image-20221011183034486.png)

   只需要框选要选择的内容,burp会自动配置匹配规则

5. 设置token的payload时选择

   ![image-20221011183935372](%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E.assets/image-20221011183935372.png)

6. 将最大线程设置为1,防止token错乱

   ![image-20221011184018814](%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E.assets/image-20221011184018814.png)

   即可开始爆破

   ![image-20221011184136106](%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E.assets/image-20221011184136106.png)

   根据长度排序后可以看出密码为123456的请求比较突出,

   ![image-20221011184203728](%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E.assets/image-20221011184203728.png)

   登录成功



## 修复建议

增加验证码功能

增加错误次数限制

不要将具体报错信息显示在前台

## 乌云逻辑漏洞

### 撞库

拿到一个站的用户数据后,拿这些用户的信息构造社工字典去尝试爆破其他多个网站

### 找到一个系统后台,进入方法(登录界面漏洞):

1. 信息收集
2. SQL注入
   1. 万能密码
   2. 万能用户名
3. XSS(打用户名,一般登录日志只会记录登录的用户名;也可以都打)
4. RCE(重点:容器漏洞)
5. 逻辑漏洞
   1. 空
   2. 空密码
   3. 明文传输
   4. 弱口令手工、爆破
   5. 默认密码
   6. 爆破用户名(根据返回长度不同判断用户名是否存在等)
   7. 短信轰炸
   8. 验证码漏洞
   9. 找回密码漏洞
   10. 有账号的情况下,进入后台越权
6. XXE
7. 社工
   1. 钓鱼(容易暴露自己)

### cookie混淆

重置密码中，同一个浏览器打开不同页面使用不同的账号登录

验证码与cookie绑定而两个账号cookie相同

http://wooyun.2xss.cc/bug_detail.php?wybug_id=wooyun-2016-0226583



报错模糊化处理

管理员密码找回改由人工认证，取消后台自动跳转



### 跳过手机号验证

抓包以及前端源码发现手机号是明文

发现有密码找回后的页面链接，直接跳过验证的步骤

http://wooyun.2xss.cc/bug_detail.php?wybug_id=wooyun-2016-0211505



### 验证码

通过cookie中的PHPSESSID判断验证码，通过更改PHPSESSID绕过



### CMS作用

1. 信息搜集时找历史漏洞

2. 找网站的CMS，然后去fofa找采用这个CMS的其他网站的漏洞

### 弱口令反向爆破用户名

找不到管理员账户的情况下,使用常用弱口令作为密码去爆破用户名,拿到用户名后尝试越权

### 手机号可随意指定

获取验证码的手机号直接通过url或者未加密的POST传到后端,可随意修改为指定号码