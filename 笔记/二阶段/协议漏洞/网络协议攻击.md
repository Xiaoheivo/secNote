## 学习目标、重难点知识】

### 【学习目标】

1. <u>整理、背诵ARP攻击的原理</u>
2. <u>ARP攻击防御思路</u>
3. ARP攻击复现



![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650376157641-4f9b3029-34fb-4070-9928-42f90cac3cf3.png)

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650376252959-fce07aa1-d931-47ff-87ab-037fa41b689a.png)

### Mac地址

查看mac地址：ipconfig /all

12位16进制数字， 占用48bits。

### ARP协议是什么？

将ip转成mac地址的协议

## ARP工作原理（理解）

### 工作机制

假设 A 和 B 位于同一链路，不需要经过路由器的转换，主机 A 向主机 B 发送一个 IP 分组，主机 A 的地址是 192.168.1.2 ，主机 B 的地址是 192.168.1.3，它们都不知道对方的 MAC 地址是啥，主机 C 和 主机 D 是同一链路的其他主机。

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650377775996-e541dc1e-a962-41b6-a471-dfa9f138a95a.png)

主机 A 想要获取主机 B 的 MAC 地址，通过主机 A 会通过**广播** 的方式向以太网上的所有主机发送一个 **ARP 请求包**，这个 ARP 请求包中包含了主机 A 想要知道的主机 B 的 IP 地址。

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650377936339-40bf20b0-c343-42b9-81f8-607925bc06e0.png)

主机 A 发送的 ARP 请求包会被同一链路上的所有主机/路由器接收并进行解析。每个主机/路由器都会检查 ARP 请求包中的信息，如果 ARP 请求包中的**目标 IP 地址 和自己的相同**，就会将自己主机的 MAC 地址写入响应包返回主机 A

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650378032834-3f80fcdd-5eae-43ba-a0d4-cce7dbab95de.png)

由此，可以通过 ARP 从 IP 地址获取 MAC 地址，实现同一链路内的通信。

### ARP缓存（了解）

为了减少arp查询产生的过多网络包，网络主机在本机缓存的arp表。arp表有缓存期限。

查看arp缓存：arp -a

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650414629675-405d1758-79d7-4e28-a6b1-d0a6fc4faa35.png)

删除arp缓存：arp -d(需要管理员权限)：

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650414867648-c96f31ad-0368-4365-b548-22a901ddaeaa.png)



## <u>ARP攻击原理</u>

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650425781545-47fcb696-d114-4599-a543-0581f2ee5d07.png)

网络中有A、B、C三台主机，主机A与主机B正常通信，主机C进入网络，开始实施ARP欺骗。

首先，主机C给主机A发一个ARP应答报文，报文显示主机B的IP地址映射主机C的MAC，主机A收到这个报文，更新自己的ARP缓存表，修改主机B的IP地址对应的MAC。这样，其后主机A发往主机B的数据包均会发给主机C。

如果主机C不转发该数据包到主机B，则主机B认为与主机A的通信发生故障，而主机A无法察觉。

如果主机C转发数据包到主机B，则主机B与主机A之间的通信不受影响，仅仅是主机C监听到主机A到主机B的数据包。同理，主机C发ARP应答报文欺骗主机B，则主机B发往主机A的数据包被主机C监听。

推荐：攻击机发送伪造的ARP广播，导致受害机获得通信目标主机的错误MAC地址，进而受害机流量被发到预期外主机上。

## <u>ARP攻击的危害</u>

冒充其他主机的MAC身份导致：

- **ARP 泛洪攻击**：通过向网关发送大量 ARP 报文，导致网关无法正常响应。

- **ARP 欺骗普通主机攻击**

- **欺骗网关的攻击**

- **中间人攻击**

## ARP攻击复现

### 攻击准备

攻击机： kali

被攻击机：centos7靶机

被攻击机：winserver2008

### 欺骗主机实现断网攻击

先在kali中获取需要攻击的目标ip地址以及网关的ip地址：

```shell
# 扫描对应网段所有存活的主机
fping -asg 192.168.3.0/24

# 或者使用也可以得到对应的效果
nmap -sP 192.168.3.0/24
```

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650461565472-e161c1e8-72f0-4ded-8327-9cef78e2ac02.png)

我们确定需要攻击的目标ip：**192.168.3.155**

**网关的ip：192.168.3.1**

也是就我们的winserver2008靶机。

注意：在执行攻击之前很多命令都需要管理员权限。

这里要用到一个arp欺骗工具：**arpspoof**, 这个工具kali里面直接输入对应的命令回车，如果没有会让你安装。

这个工具相当于可以不停的去发送欺骗数据包。

```shell
arpspoof   -i   网卡   -t    目标IP    网关
也可以使用反向欺骗：
arpspoof   -i   网卡   -t    网关    目标IP
```

攻击之前先确定目标主机是可以上网的：

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650462741494-9788b3cd-6363-445f-bd14-19f9bd9ab835.png)

执行命令：

```php
# 这条命令的意思：
# -i 指定网卡 eth0 kali自己的网卡
# -t 指定目标主机IP
# 192.168.3.155 目标主机IP
# 192.168.3.1 网关的IP
# 意思就是不停的告诉 目标主机， 我是网关我是网关， 然后就断网了
arpspoof -i eth0 -t  192.168.3.155 192.168.3.1
```

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650464353048-ef2e3418-00a3-44fc-b49f-d03b70c76b84.png)

执行之后，目标主机：

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650463074766-603c93ed-803f-42e0-9b47-76654f2bfee2.png)

要想结束断网，直接结束arp欺骗即可。

### 流量转发窃取用户隐私数据（中间人）

#### 原理

在上面的例子中我们将winserver2008给断网了，是因为我们没有开启流量转发。

我们要想获取用户的隐私数据，那么必须要让用户在**不知情**的情况下，进行上网，然后输入一些隐私数据，比如：用户名和密码之类的。

这个时候我们就需要开启kali的流量转发，要让winserver2008能够上网这个时候的流程就变成了：

**winserver2008 ====>kali====>网关=====>kali=====>winserver2008**

相当于就是winserver2008将数据发送到kali的网卡， kali网卡再将数据转发给网关。

那么我们要做的事情就是：

**kali 欺骗 winserver2008  自己是网关  =》 正向欺骗**

**kali 欺骗 网关  自己是winserver2008  =》 反向欺骗**

这样相当于是 kali对流量进行了 **中转**

#### 开启流量转发

```shell
echo 1 > /proc/sys/net/ipv4/ip_forward
```

**/proc/sys/net/ipv4/ip_forward**是配置文件，默认内容为0，表示IP转发是关闭的，使用上述命令将该配置文件的内容改写为1，表示开启IP转发。开启IP转发后 流量会经过kali的主机而后再去到目标所以这时开启arpspoof 那么目标就不会断网，因为流量通过了kali主机那么我们就可以拦截相关数据。

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650465229195-da7ae26d-de9b-4d01-8479-c4649cb38e0e.png)

#### 欺骗winserver2008

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650465392437-3e8a453b-1f18-4fd3-b15e-12270f11dd5f.png)

查看winserver2008:

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650465437123-92b1630c-741c-4de9-92cc-910ce85dd907.png)

看一下arp缓存：

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650465601940-2a8adc20-7bf4-4772-9070-6be4c3d630a8.png)

#### 欺骗网关

新开一个窗口：

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650465834153-00fab09a-0ee6-4a90-8022-64141f820c86.png)

#### 开启wireshark进行抓包

这一步主要是看是否能抓到包

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650465994054-24c29113-ab7b-4b11-b5d7-9cd0a9e3cbee.png)

在winserver2008中去ping一下centos靶机：192.168.3.141

![image-20221013225911178](%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/image-20221013225911178.png)

然后看是否能抓到：

![image-20221013225858066](%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/image-20221013225858066.png)

确实抓到了包。

wireshark抓到的二层协议的包，我们要想得到用户的铭感数据，那么需要抓传输层协议的包，也就是抓http包。

#### ettercap进行铭感数据获取

在kali中新开一个窗口：

```shell
# -T 文本模式显示
# -q 安静模式
# -i 指定网卡
ettercap -Tq -i eth0
```

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650467421601-65398302-a024-4ed3-a789-9dcf846cb19a.png)

然后在winserver2008中进行一个网址的登录：

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650467479206-3be0450a-3be4-4db0-984a-cbe1bb6245c8.png)

观察ettercap：

![img](./%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB.assets/1650467522760-f16b4bb8-f6a9-4751-9b54-2bdf0dcb4823.png)

ettercap这个工具很强大，可以干很多事情。但是不要去乱作。

记住一句话： kali用的好，。。。。。。。。

## ARP防御

**1.主机级被动检测**

当系统接收到来自局域网上的ARP请求时，系统检查该请求发送端的IP地址是否与自己的IP地址相同。如果相同，则说明该网络上另有一台机器与自己具有相同的IP地址。

**2.主机级主动检测**

主机定期向所在局域网发送查询自己IP地址的ARP请求报文。如果能够收到另一ARP响应报文，则说明该网络上另有一台机器与自己具有相同的IP地址。

**3.服务器级检测**

当服务器收到ARP响应时，为了证实它的真实性，根据反向地址解析协议(RARP)就用从响应报文中给出的MAC地址再生成一个RARP请求，它询问这样一个问题：“如果你是这个MAC地址的拥有者，请回答你的IP地址”。这样就会查询到这个MAC地址对应的IP地址，比较这两个IP地址，如果不同，则说明对方伪造了ARP响应报文。

**4.网络级检测**

配置主机定期向中心管理主机报告其ARP缓存的内容。这样中心管理主机上的程序就会查找出两台主机报告信息的不一致，以及同一台主机前后报告内容的变化。这些情况反映了潜在的安全问题。或者利用网络嗅探工具连续监测网络内主机硬件地址与IP地址对应关系的变化。

\~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

上面的太官方，下面好懂一点：

- 在客户端使用arp命令绑定网关的真实MAC地址命令如下：

arp -d *(先清除错误的ARP表)

arp -s 192.168.xxx.xxx  xx-xx-xx-xx-xx-xx(静态指定网关的MAC地址)

- 在交换机上做端口与MAC地址的静态帮定。
- 在路由器上做IP地址与MAC地址的静态绑定。
- 使用”ARPSERVER”按一定时间间隔广播网段内所有主机的正确IP-MAC映射表。
- 最主要是要提高用户的安全意识，养成良好的安全习惯，包括：及时安装系统补丁程序，为系统设置强壮的密码，安装防火墙，安装有效的杀毒软件并及时升级病毒库
- 不主动进行网络攻击，不随便运行不受信任的软件。